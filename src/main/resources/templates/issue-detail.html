<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="content" th:if="${issue}">

    <div class="page-header">
        <div>
            <a href="/issues" hx-get="/issues" hx-target="#content" hx-push-url="true" class="text-muted text-sm">&larr; Back to queue</a>
            <h2 th:text="${'#' + issue.issueNumber + ' — ' + issue.issueTitle}">Issue Title</h2>
        </div>
        <div class="flex gap-1" style="align-items:center">
            <span class="status" th:classappend="${'status-' + issue.status.name().toLowerCase()}" th:text="${issue.status}">STATUS</span>
            <button th:if="${issue.status.name() == 'FAILED' or issue.status.name() == 'COOLDOWN'}"
                    type="button" class="btn btn-sm" style="font-size:0.75rem;padding:0.25rem 0.75rem"
                    onclick="document.getElementById('retry-modal').style.display='flex'">Retry</button>
        </div>
    </div>

    <!-- Retry Modal (outside page-header to avoid stacking context from animation) -->
    <div th:if="${issue.status.name() == 'FAILED' or issue.status.name() == 'COOLDOWN'}"
         id="retry-modal" style="display:none;position:fixed;inset:0;z-index:1000;align-items:center;justify-content:center;background:rgba(0,0,0,0.5)"
         onclick="if(event.target===this)this.style.display='none'">
        <div style="background:var(--bg-card,#1e1e2e);border:1px solid var(--border,#333);border-radius:8px;padding:1.5rem;width:90%;max-width:500px;box-shadow:0 8px 32px rgba(0,0,0,0.4)">
            <h3 style="margin:0 0 0.5rem">Retry Issue</h3>
            <p class="text-sm text-muted" style="margin:0 0 1rem">Optionally add instructions for the next attempt. These will be posted as a comment on the GitHub issue and provided to Claude Code.</p>
            <form th:action="@{'/issues/' + ${issue.id} + '/retry'}" method="post">
                <textarea name="instructions" rows="4"
                          placeholder="e.g. Break this into smaller changes, focus on the API layer first..."
                          style="width:100%;box-sizing:border-box;background:var(--bg-main,#12121a);color:var(--text,#e0e0e0);border:1px solid var(--border,#333);border-radius:4px;padding:0.75rem;font-family:inherit;font-size:0.875rem;resize:vertical"></textarea>
                <div style="display:flex;gap:0.5rem;justify-content:flex-end;margin-top:1rem">
                    <button type="button" class="btn btn-sm" style="font-size:0.75rem;padding:0.25rem 0.75rem;opacity:0.7"
                            onclick="document.getElementById('retry-modal').style.display='none'">Cancel</button>
                    <button type="submit" class="btn btn-sm" style="font-size:0.75rem;padding:0.25rem 0.75rem">Start Retry</button>
                </div>
            </form>
        </div>
    </div>

    <!-- === BLOCKED-BY INFO PANEL === -->
    <div th:if="${issue.status.name() == 'BLOCKED' and issue.blockedByIssues != null}" class="panel mb-3">
        <div class="panel-header">
            <h3>Blocked By</h3>
            <span class="status status-blocked">WAITING</span>
        </div>
        <div class="panel-body">
            <p class="text-sm" style="margin-bottom:0.5rem">This issue is waiting for the following issues to be completed before processing can begin:</p>
            <div class="flex gap-1" style="flex-wrap:wrap">
                <span th:each="num : ${issue.blockerNumbers}"
                      class="status status-blocked"
                      th:text="${'#' + num}">
                    #5
                </span>
            </div>
        </div>
    </div>

    <!-- === LIVE-REFRESHED STATUS SECTION === -->
    <div th:replace="~{issue-detail :: live-status}"></div>

    <!-- === LIVE TERMINAL (outside HTMX swap) === -->
    <div th:if="${issue.status.name() == 'IN_PROGRESS'}" class="panel mb-3 live-terminal-panel" id="live-terminal-panel">
        <div class="panel-header">
            <h3>Claude Code Session</h3>
            <div class="flex gap-1" style="align-items:center">
                <span class="status-dot running"></span>
                <span class="text-sm text-muted">Streaming</span>
            </div>
        </div>
        <div class="panel-body" style="padding:0">
            <div id="live-terminal" class="live-terminal">
                <div class="terminal-line terminal-system">Waiting for Claude Code output...</div>
            </div>
        </div>
    </div>
    <script th:if="${issue.status.name() == 'IN_PROGRESS'}" th:inline="javascript">
    (function() {
        if (window.__issueBotES) return; // already initialized

        var issueId = /*[[${issue.id}]]*/ 0;
        var terminal = document.getElementById('live-terminal');
        if (!terminal) return;

        var es = new EventSource('/api/events/stream');
        window.__issueBotES = es;
        var lineCount = 0;
        var maxLines = 200;

        es.addEventListener('claude-log', function(e) {
            try {
                var data = JSON.parse(e.data);
                if (data.issueId !== issueId) return;

                // Remove the "waiting" message on first real line
                if (lineCount === 0) {
                    terminal.innerHTML = '';
                }

                var line = document.createElement('div');
                line.className = 'terminal-line';
                var text = data.text || '';

                if (text.startsWith('[tool]')) {
                    line.className += ' terminal-tool';
                } else if (text.startsWith('[result]')) {
                    line.className += ' terminal-result';
                }

                line.textContent = text;
                terminal.appendChild(line);
                lineCount++;

                // Keep max lines
                while (terminal.children.length > maxLines) {
                    terminal.removeChild(terminal.firstChild);
                }

                // Auto-scroll to bottom
                terminal.scrollTop = terminal.scrollHeight;
            } catch(err) {}
        });

        es.addEventListener('issue-update', function(e) {
            // Handled by HTMX polling on the status section
        });

        // Cleanup when page navigates away
        document.addEventListener('htmx:beforeSwap', function(evt) {
            // Only close if we're leaving this page (swapping #content)
            if (evt.detail.target && evt.detail.target.id === 'content') {
                es.close();
                window.__issueBotES = null;
            }
        });
    })();
    </script>

    <!-- === ITERATION HISTORY === -->
    <div class="panel mb-3">
        <div class="panel-header">
            <h3>Iteration History</h3>
        </div>
        <div class="panel-body">
            <ul class="iteration-timeline" th:if="${not #lists.isEmpty(iterations)}">
                <li th:each="iter : ${iterations}"
                    th:classappend="${iter.ciResult == 'PASSED' ? 'passed' : (iter.completedAt != null ? 'failed' : 'active')}">
                    <div class="flex-between mb-1">
                        <strong th:text="${'Iteration ' + iter.iterationNum}">Iteration 1</strong>
                        <span class="text-sm text-muted" th:if="${iter.completedAt != null}" th:text="${#temporals.format(iter.startedAt, 'MMM d HH:mm') + ' — ' + #temporals.format(iter.completedAt, 'HH:mm')}">time</span>
                        <span class="text-sm text-muted" th:if="${iter.completedAt == null}" th:text="${#temporals.format(iter.startedAt, 'MMM d HH:mm') + ' — running...'}">time</span>
                    </div>

                    <div th:if="${iter.ciResult != null}" class="mb-1">
                        <span class="text-sm">CI: </span>
                        <span class="status" th:classappend="${iter.ciResult == 'PASSED' ? 'status-completed' : 'status-failed'}" th:text="${iter.ciResult}">RESULT</span>
                    </div>

                    <details th:if="${iter.selfAssessment != null}">
                        <summary class="text-sm">Self-Assessment</summary>
                        <pre class="code-output" th:text="${iter.selfAssessment}">assessment</pre>
                    </details>

                    <details th:if="${iter.diff != null and not #strings.isEmpty(iter.diff)}">
                        <summary class="text-sm">Diff</summary>
                        <div class="diff-viewer" th:text="${iter.diff}">diff content</div>
                    </details>

                    <details th:if="${iter.claudeOutput != null and not #strings.isEmpty(iter.claudeOutput)}">
                        <summary class="text-sm">Claude Code Output</summary>
                        <pre class="code-output" th:text="${iter.claudeOutput}">output</pre>
                    </details>

                    <!-- Review Scores -->
                    <div th:if="${iter.reviewPassed != null}" class="review-scores mt-1">
                        <div class="flex-between mb-1">
                            <span class="text-sm">Independent Review:</span>
                            <span class="status" th:classappend="${iter.reviewPassed ? 'status-completed' : 'status-failed'}"
                                  th:text="${iter.reviewPassed ? 'PASSED' : 'FAILED'}">RESULT</span>
                        </div>
                        <div th:if="${iter.reviewModel != null}" class="text-sm text-muted mb-1"
                             th:text="'Model: ' + ${iter.reviewModel}">model</div>
                        <details th:if="${iter.reviewJson != null and not #strings.isEmpty(iter.reviewJson)}">
                            <summary class="text-sm">Review Details</summary>
                            <pre class="code-output" th:text="${iter.reviewJson}">review json</pre>
                        </details>
                    </div>
                </li>
            </ul>
            <p class="text-muted" th:if="${#lists.isEmpty(iterations)}">No iterations yet.</p>
        </div>
    </div>

    <!-- === ACTIVITY LOG === -->
    <div class="panel">
        <div class="panel-header">
            <h3>Activity Log</h3>
            <span class="text-sm text-muted" th:text="${#lists.size(events) + ' events'}">0 events</span>
        </div>
        <div class="panel-body">
            <ul class="events-feed" th:if="${not #lists.isEmpty(events)}">
                <li th:each="event : ${events}">
                    <span class="time" th:text="${#temporals.format(event.createdAt, 'HH:mm:ss')}">12:00:00</span>
                    <span class="type" th:text="${event.eventType}">EVENT</span>
                    <span th:text="${event.message}">message</span>
                </li>
            </ul>
            <p class="text-muted" th:if="${#lists.isEmpty(events)}">No events for this issue.</p>
        </div>
    </div>
</div>

<!-- === FRAGMENT: auto-refreshed status section (metrics + phase pipeline) === -->
<div th:fragment="live-status" id="live-status"
     th:if="${issue}"
     hx-ext="morph"
     th:attr="hx-get=${issue.status.name() == 'IN_PROGRESS' ? '/issues/' + issue.id + '/live-status' : ''}"
     th:hx-trigger="${issue.status.name() == 'IN_PROGRESS' ? 'every 5s' : 'none'}"
     hx-target="#live-status"
     hx-swap="morph:outerHTML">

    <div class="metrics-grid mb-3">
        <div class="metric-card">
            <div class="label">Repository</div>
            <div class="value small" th:text="${issue.repo.fullName()}">owner/repo</div>
        </div>
        <div class="metric-card">
            <div class="label">Iteration</div>
            <div class="value" th:text="${issue.currentIteration + '/' + issue.repo.maxIterations}">0/5</div>
        </div>
        <div class="metric-card">
            <div class="label">Branch</div>
            <div class="value small" th:text="${issue.branchName != null ? issue.branchName : '—'}">—</div>
        </div>
        <div class="metric-card">
            <div class="label">Review Iter</div>
            <div class="value" th:text="${issue.currentReviewIteration + '/' + issue.repo.maxReviewIterations}">0/2</div>
        </div>
        <div class="metric-card">
            <div class="label">Cost</div>
            <div class="value small" th:text="'$' + ${#numbers.formatDecimal(totalCost, 1, 4)}">$0.00</div>
        </div>
    </div>

    <!-- Phase pipeline -->
    <div th:if="${issue.status.name() == 'IN_PROGRESS' and issue.currentPhase != null}" class="panel mb-3 live-monitor">
        <div class="panel-header">
            <h3>Live Progress</h3>
            <span class="status status-in_progress" style="font-size:0.6rem">ACTIVE</span>
        </div>
        <div class="panel-body">
            <div class="phase-pipeline" th:with="phase=${issue.currentPhase != null ? issue.currentPhase : ''},
                     phases=${ {'SETUP','IMPLEMENTATION','CI_VERIFICATION','PR_CREATION','INDEPENDENT_REVIEW','COMPLETION'} },
                     phaseIndex=${phase == 'SETUP' ? 0 : (phase == 'IMPLEMENTATION' ? 1 : (phase == 'CI_VERIFICATION' ? 2 : (phase == 'PR_CREATION' ? 3 : (phase == 'INDEPENDENT_REVIEW' ? 4 : (phase == 'COMPLETION' ? 5 : -1)))))}">
                <div class="phase-step" th:classappend="${phaseIndex == 0 ? 'active' : (phaseIndex > 0 ? 'done' : 'pending')}">
                    <div class="phase-indicator"></div>
                    <div class="phase-info">
                        <div class="phase-name">Setup</div>
                        <div class="phase-desc">Clone &amp; branch</div>
                    </div>
                </div>
                <div class="phase-step" th:classappend="${phaseIndex == 1 ? 'active' : (phaseIndex > 1 ? 'done' : 'pending')}">
                    <div class="phase-indicator"></div>
                    <div class="phase-info">
                        <div class="phase-name">Implementation</div>
                        <div class="phase-desc">Opus writing code</div>
                    </div>
                </div>
                <div class="phase-step" th:classappend="${phaseIndex == 2 ? 'active' : (phaseIndex > 2 ? 'done' : 'pending')}">
                    <div class="phase-indicator"></div>
                    <div class="phase-info">
                        <div class="phase-name">CI Checks</div>
                        <div class="phase-desc">Compile &amp; test</div>
                    </div>
                </div>
                <div class="phase-step" th:classappend="${phaseIndex == 3 ? 'active' : (phaseIndex > 3 ? 'done' : 'pending')}">
                    <div class="phase-indicator"></div>
                    <div class="phase-info">
                        <div class="phase-name">Draft PR</div>
                        <div class="phase-desc">Create pull request</div>
                    </div>
                </div>
                <div class="phase-step" th:classappend="${phaseIndex == 4 ? 'active' : (phaseIndex > 4 ? 'done' : 'pending')}">
                    <div class="phase-indicator"></div>
                    <div class="phase-info">
                        <div class="phase-name">Code Review</div>
                        <div class="phase-desc">Sonnet 4.6 review</div>
                    </div>
                </div>
                <div class="phase-step" th:classappend="${phaseIndex == 5 ? 'active' : 'pending'}">
                    <div class="phase-indicator"></div>
                    <div class="phase-info">
                        <div class="phase-name">Completion</div>
                        <div class="phase-desc">Finalize &amp; merge</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
