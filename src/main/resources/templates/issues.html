<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="content">
    <div class="page-header">
        <h2>Issue Queue</h2>
        <button class="btn btn-outline btn-sm"
                hx-get="/issues/table"
                hx-target="#issue-table-body"
                hx-swap="innerHTML">Refresh</button>
    </div>

    <div class="filter-bar">
        <select hx-get="/issues" hx-target="#content" name="status" hx-include="[name='repoId']">
            <option value="">All Statuses</option>
            <option th:each="s : ${statuses}" th:value="${s}" th:text="${s}" th:selected="${s.name() == selectedStatus}">STATUS</option>
        </select>
        <select hx-get="/issues" hx-target="#content" name="repoId" hx-include="[name='status']">
            <option value="">All Repos</option>
            <option th:each="repo : ${repos}" th:value="${repo.id}" th:text="${repo.fullName()}" th:selected="${repo.id == selectedRepoId}">owner/repo</option>
        </select>
    </div>

    <div hx-ext="sse" sse-connect="/api/events/stream">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Repo</th>
                    <th>#</th>
                    <th>Title</th>
                    <th>Status</th>
                    <th>Phase</th>
                    <th>Iteration</th>
                    <th>Updated</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="issue-table-body"
                   hx-ext="morph"
                   hx-get="/issues/table"
                   hx-trigger="sse:issue-update"
                   hx-swap="morph:innerHTML"
                   hx-on::after-swap="htmx.process(this)">
                <tr th:replace="~{issues :: table-rows}"></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Fragment: just the table rows, returned by /issues/table -->
<th:block th:fragment="table-rows">
    <tr th:each="issue : ${issues}"
        style="cursor:pointer"
        th:attr="hx-get='/issues/' + ${issue.id}"
        hx-target="#content"
        hx-push-url="true">
        <td th:text="${issue.repo.fullName()}">owner/repo</td>
        <td th:text="${'#' + issue.issueNumber}">#1</td>
        <td th:text="${issue.issueTitle}">Issue title</td>
        <td>
            <span class="status" th:classappend="${'status-' + issue.status.name().toLowerCase()}" th:text="${issue.status}">PENDING</span>
        </td>
        <td class="text-sm" th:text="${issue.status.name() == 'BLOCKED' and issue.blockedByIssues != null ? 'Waiting on #' + issue.blockedByIssues.replace(',', ', #') : (issue.currentPhase != null ? issue.currentPhase : '—')}">—</td>
        <td th:text="${issue.currentIteration + '/' + issue.repo.maxIterations}">0/5</td>
        <td class="text-sm text-muted" th:text="${#temporals.format(issue.updatedAt, 'MMM d HH:mm')}">Jan 1 12:00</td>
        <td>
            <button th:if="${issue.status.name() == 'QUEUED' and !issue.repo.autoStart}"
                    class="btn btn-primary btn-sm"
                    th:attr="hx-post='/issues/' + ${issue.id} + '/start'"
                    hx-target="#content"
                    onclick="event.stopPropagation()">Start</button>
        </td>
    </tr>
    <tr th:if="${#lists.isEmpty(issues)}">
        <td colspan="8" class="text-muted" style="text-align:center;padding:2rem">No tracked issues. Label a GitHub issue <code>agent-ready</code> to start.</td>
    </tr>
</th:block>
</body>
</html>
