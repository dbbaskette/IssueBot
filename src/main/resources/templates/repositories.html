<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="content">
    <div class="page-header">
        <h2>Repositories</h2>
        <button class="btn btn-primary" onclick="resetAndShowForm()">Add Repository</button>
    </div>

    <!-- Add/Edit Form -->
    <div id="add-repo-form" class="panel mb-3" style="display:none">
        <div class="panel-header">
            <h3 id="form-title">Add Repository</h3>
            <button class="btn btn-outline btn-sm" onclick="document.getElementById('add-repo-form').style.display='none'">Cancel</button>
        </div>
        <div class="panel-body">
            <form hx-post="/repositories" hx-target="#content" hx-swap="innerHTML">
                <input type="hidden" id="edit-id" name="id" value="">
                <div class="form-grid">
                    <div>
                        <label for="owner">Owner</label>
                        <input type="text" id="owner" name="owner" required placeholder="e.g. my-org">
                    </div>
                    <div>
                        <label for="repo-name">Repository</label>
                        <input type="text" id="repo-name" name="name" required placeholder="e.g. my-app">
                    </div>
                    <div>
                        <label for="branch">Branch</label>
                        <input type="text" id="branch" name="branch" value="main" required>
                    </div>
                    <div>
                        <label for="mode">Mode</label>
                        <select id="mode" name="mode">
                            <option value="AUTONOMOUS">Autonomous</option>
                            <option value="APPROVAL_GATED">Approval Gated</option>
                        </select>
                    </div>
                    <div>
                        <label for="max-iterations">Max Iterations</label>
                        <input type="number" id="max-iterations" name="maxIterations" value="5" min="1" max="20">
                    </div>
                    <div style="display:flex;flex-direction:column;gap:0.6rem">
                        <div style="display:flex;align-items:center;gap:0.5rem;margin-top:1.6rem">
                            <input type="checkbox" id="ci-enabled" name="ciEnabled" value="true" checked
                                   style="width:auto;accent-color:var(--amber)"
                                   onchange="document.getElementById('ci-timeout-group').style.display = this.checked ? '' : 'none'">
                            <label for="ci-enabled" style="margin:0;text-transform:none;font-size:0.82rem;color:var(--text-secondary)">CI / GitHub Actions enabled</label>
                        </div>
                        <div style="display:flex;align-items:center;gap:0.5rem">
                            <input type="checkbox" id="auto-merge" name="autoMerge" value="true"
                                   style="width:auto;accent-color:var(--amber)">
                            <label for="auto-merge" style="margin:0;text-transform:none;font-size:0.82rem;color:var(--text-secondary)">Auto-merge PRs (squash)</label>
                        </div>
                        <div style="display:flex;align-items:center;gap:0.5rem">
                            <input type="checkbox" id="security-review" name="securityReviewEnabled" value="true"
                                   style="width:auto;accent-color:var(--amber)">
                            <label for="security-review" style="margin:0;text-transform:none;font-size:0.82rem;color:var(--text-secondary)">Security review (OWASP)</label>
                        </div>
                    </div>
                    <div id="ci-timeout-group">
                        <label for="ci-timeout">CI Timeout (min)</label>
                        <input type="number" id="ci-timeout" name="ciTimeoutMinutes" value="15" min="1" max="60">
                    </div>
                    <div>
                        <label for="max-review-iterations">Max Review Iterations</label>
                        <input type="number" id="max-review-iterations" name="maxReviewIterations" value="2" min="1" max="10">
                    </div>
                    <div class="full-width">
                        <label for="allowed-paths">Allowed Paths (comma-separated)</label>
                        <input type="text" id="allowed-paths" name="allowedPaths" placeholder="src/, test/">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Success/Error messages -->
    <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <!-- Repository table -->
    <table class="data-table">
        <thead>
            <tr>
                <th>Repository</th>
                <th>Branch</th>
                <th>Mode</th>
                <th>Max Iter.</th>
                <th>CI</th>
                <th>Review</th>
                <th>Merge</th>
                <th>Issues</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="repo : ${repos}">
                <td>
                    <strong th:text="${repo.owner + '/' + repo.name}">owner/repo</strong>
                </td>
                <td th:text="${repo.branch}">main</td>
                <td>
                    <span class="status" th:classappend="${repo.mode.name() == 'AUTONOMOUS' ? 'status-completed' : 'status-awaiting_approval'}" th:text="${repo.mode}">AUTONOMOUS</span>
                </td>
                <td th:text="${repo.maxIterations}">5</td>
                <td>
                    <span th:if="${repo.ciEnabled}" class="status status-completed">ON</span>
                    <span th:unless="${repo.ciEnabled}" class="status status-pending">OFF</span>
                </td>
                <td>
                    <span th:if="${repo.securityReviewEnabled}" class="status status-awaiting_approval" title="Security review enabled">SEC</span>
                    <span th:text="${repo.maxReviewIterations}" class="text-sm text-muted" th:title="'Max ' + ${repo.maxReviewIterations} + ' review iterations'"></span>
                </td>
                <td>
                    <span th:if="${repo.autoMerge}" class="status status-completed">AUTO</span>
                    <span th:unless="${repo.autoMerge}" class="status status-pending">MANUAL</span>
                </td>
                <td th:text="${issueCounts.containsKey(repo.id) ? issueCounts.get(repo.id) : 0}">0</td>
                <td style="display:flex;gap:0.3rem">
                    <button class="btn btn-outline btn-sm"
                            th:attr="onclick='editRepo(' + ${repo.id} + ', '
                                + '\'' + ${repo.owner} + '\', '
                                + '\'' + ${repo.name} + '\', '
                                + '\'' + ${repo.branch} + '\', '
                                + '\'' + ${repo.mode.name()} + '\', '
                                + ${repo.maxIterations} + ', '
                                + ${repo.ciEnabled} + ', '
                                + ${repo.ciTimeoutMinutes} + ', '
                                + ${repo.autoMerge} + ', '
                                + ${repo.securityReviewEnabled} + ', '
                                + ${repo.maxReviewIterations} + ')'">Edit</button>
                    <button class="btn btn-danger btn-sm"
                            th:attr="hx-delete='/repositories/' + ${repo.id}"
                            hx-target="#content"
                            hx-confirm="Remove this repository? Local clones will not be deleted.">Remove</button>
                </td>
            </tr>
            <tr th:if="${#lists.isEmpty(repos)}">
                <td colspan="9" class="text-muted" style="text-align:center;padding:2rem">No repositories configured. Click "Add Repository" to get started.</td>
            </tr>
        </tbody>
    </table>

    <script>
        function resetAndShowForm() {
            document.getElementById('form-title').textContent = 'Add Repository';
            document.getElementById('edit-id').value = '';
            document.getElementById('owner').value = '';
            document.getElementById('repo-name').value = '';
            document.getElementById('branch').value = 'main';
            document.getElementById('mode').value = 'AUTONOMOUS';
            document.getElementById('max-iterations').value = '5';
            document.getElementById('ci-enabled').checked = true;
            document.getElementById('ci-timeout').value = '15';
            document.getElementById('ci-timeout-group').style.display = '';
            document.getElementById('auto-merge').checked = false;
            document.getElementById('security-review').checked = false;
            document.getElementById('max-review-iterations').value = '2';
            document.getElementById('add-repo-form').style.display = 'block';
        }

        function editRepo(id, owner, name, branch, mode, maxIterations, ciEnabled, ciTimeoutMinutes, autoMerge, securityReviewEnabled, maxReviewIterations) {
            document.getElementById('form-title').textContent = 'Edit Repository';
            document.getElementById('edit-id').value = id;
            document.getElementById('owner').value = owner;
            document.getElementById('repo-name').value = name;
            document.getElementById('branch').value = branch;
            document.getElementById('mode').value = mode;
            document.getElementById('max-iterations').value = maxIterations;
            document.getElementById('ci-enabled').checked = ciEnabled;
            document.getElementById('ci-timeout').value = ciTimeoutMinutes;
            document.getElementById('ci-timeout-group').style.display = ciEnabled ? '' : 'none';
            document.getElementById('auto-merge').checked = autoMerge;
            document.getElementById('security-review').checked = securityReviewEnabled;
            document.getElementById('max-review-iterations').value = maxReviewIterations;
            document.getElementById('add-repo-form').style.display = 'block';
        }
    </script>
</div>
</body>
</html>
